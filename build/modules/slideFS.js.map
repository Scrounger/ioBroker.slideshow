{
  "version": 3,
  "sources": ["../../src/modules/slideFS.ts"],
  "sourcesContent": ["import { GlobalHelper } from \"./global-helper\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport * as imgsize from \"image-size\";\nimport { getPictureInformation } from \"./exif\"\n\nexport interface FSPicture{\n\tpath:string,\n\turl: string,\n\tinfo1: string,\n\tinfo2: string,\n\tinfo3: string,\n\tdate: Date | null\n}\n\nexport interface FSPictureListUpdateResult{\n\tsuccess: boolean;\n\tpicturecount: number;\n}\n\nlet CurrentImages: FSPicture[];\nlet CurrentImage: FSPicture;\n\nexport async function getPicture(Helper: GlobalHelper): Promise<FSPicture | null> {\n\ttry{\n\t\tif (CurrentImages.length === 0){\n\t\t\tawait updatePictureList(Helper);\n\t\t}\n\t\tif (CurrentImages.length !== 0){\n\t\t\tif (!CurrentImage){\n\t\t\t\tCurrentImage = CurrentImages[0];\n\t\t\t} else {\n\t\t\t\tif (CurrentImages.indexOf(CurrentImage) === CurrentImages.length - 1){\n\t\t\t\t\tCurrentImage = CurrentImages[0];\n\t\t\t\t} else {\n\t\t\t\t\tCurrentImage = CurrentImages[CurrentImages.indexOf(CurrentImage) + 1];\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (fs.existsSync(CurrentImage.path) === true){\n\t\t\t\tconst PicContent = fs.readFileSync(CurrentImage.path);\n\t\t\t\tconst PicContentB64 = PicContent.toString(\"base64\");\n\t\t\t\treturn { ...CurrentImage, url: `data:image/jpeg;base64,${PicContentB64}`};\n\t\t\t}else{\n\t\t\t\tHelper.ReportingError(null, `File not accessible: ${CurrentImage.path}`, \"Filesystem\", \"getPicture\", \"\", false);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}catch(err){\n\t\tHelper.ReportingError(err as Error, \"Unknown Error\", \"Filesystem\", \"getPicture\");\n\t\treturn null;\n\t}\n}\n\nexport async function updatePictureList(Helper: GlobalHelper): Promise<FSPictureListUpdateResult> {\n\ttry{\n\t\tCurrentImages = [];\n\t\t// Check if folder exists\n\t\tif (! fs.existsSync(Helper.Adapter.config.fs_path)){\n\t\t\tHelper.Adapter.log.error(`Folder ${Helper.Adapter.config.fs_path} does not exist`);\n\t\t\treturn { success: false, picturecount: 0 };\n\t\t}\n\t\t// Filter for JPEG or JPG files\n\t\tconst CurrentFileList = await getAllFiles(Helper, Helper.Adapter.config.fs_path);\n\t\tHelper.ReportingInfo(\"Info\", \"Filesystem\", `${CurrentFileList.length} total files found in folder ${Helper.Adapter.config.fs_path}`, {JSON: JSON.stringify(CurrentFileList.slice(0, 99))} );\n\t\tconst CurrentImageList = CurrentFileList.filter(function(file){\n\t\t\tif (path.extname(file).toLowerCase() === \".jpg\" || path.extname(file).toLowerCase() === \".jpeg\" || path.extname(file).toLowerCase() === \".png\"){\n\t\t\t\treturn file;\n\t\t\t}\n\t\t})\n\t\t// Checking orientation of pictures (landscape or portrait) if configured\n\t\tfor (const ImageIndex in CurrentImageList){\n\t\t\tif (Helper.Adapter.config.fs_format !== 0){\n\t\t\t\ttry {\n\t\t\t\t\tconst ImageSize = await imgsize.imageSize(CurrentImageList[ImageIndex]);\n\t\t\t\t\tif (ImageSize.width && ImageSize.height){\n\t\t\t\t\t\tif ((Helper.Adapter.config.fs_format === 1 && ImageSize.width > ImageSize.height) === true){\n\t\t\t\t\t\t\tif (Array.isArray(CurrentImages)){\n\t\t\t\t\t\t\t\tCurrentImages.push( {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} );\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tCurrentImages = [ {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} ];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ((Helper.Adapter.config.fs_format === 2 && ImageSize.height > ImageSize.width) === true){\n\t\t\t\t\t\t\tif (Array.isArray(CurrentImages)){\n\t\t\t\t\t\t\t\tCurrentImages.push( {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} );\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\tCurrentImages = [ {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} ];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\tHelper.Adapter.log.error((err as Error).message);\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tif (Array.isArray(CurrentImages)){\n\t\t\t\t\tCurrentImages.push( {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} );\n\t\t\t\t}else{\n\t\t\t\t\tCurrentImages = [ {path: CurrentImageList[ImageIndex], url: \"\", info1: \"\", info2: \"\", info3: \"\", date: null} ];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Fillup picture information\n\t\tif (Array.isArray(CurrentImages)){\n\t\t\tif (CurrentImages.length > 0) {\n\t\t\t\tawait Promise.all(CurrentImages.map(async CurrentImage => {\n\t\t\t\t\tconst fileInfo = await getPictureInformation(Helper, CurrentImage.path);\n\t\t\t\t\tfileInfo?.info1 ? CurrentImage.info1 = fileInfo?.info1 : CurrentImage.info1 = \"\";\n\t\t\t\t\tfileInfo?.info2 ? CurrentImage.info2 = fileInfo?.info2 : CurrentImage.info2 = \"\";\n\t\t\t\t\tfileInfo?.info3 ? CurrentImage.info3 = fileInfo?.info3 : CurrentImage.info3 = \"\";\n\t\t\t\t\tfileInfo?.date ? CurrentImage.date = fileInfo?.date : CurrentImage.date = null;\n\t\t\t\t}))\n\t\t\t}\n\t\t}\n\n\t\t// Sort\n\t\tswitch (Helper.Adapter.config.fs_order){\n\t\t\tcase 1:\n\t\t\t\t//Filename\n\t\t\t\tHelper.ReportingInfo(\"Debug\", \"Filesystem\", \"Sort pictures by filename\");\n\t\t\t\tCurrentImages.sort((a,b) => (a.path > b.path) ? 1 : ((b.path > a.path) ? -1 : 0))\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\t// Random order ?\n\t\t\t\tHelper.ReportingInfo(\"Debug\", \"Filesystem\", \"Sort pictures random\");\n\t\t\t\t// See https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array\n\t\t\t\tfor (let i = CurrentImages.length - 1; i > 0; i--) {\n\t\t\t\t\tconst j = Math.floor(Math.random() * (i + 1));\n\t\t\t\t\t[CurrentImages[i], CurrentImages[j]] = [CurrentImages[j], CurrentImages[i]];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t//Takendate\n\t\t\t\tHelper.ReportingInfo(\"Debug\", \"Filesystem\", \"Sort pictures by takendate\");\n\t\t\t\tCurrentImages.sort((a, b) => {\n\t\t\t\t\tif (a.date !== null && b.date !== null){\n\t\t\t\t\t\tif ( a.date < b.date ){\n\t\t\t\t\t\t\treturn -1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( a.date > b.date ){\n\t\t\t\t\t\t\treturn 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn 0;\n\t\t\t\t} )\n\t\t\t\tbreak;\n\t\t}\n\n\t\t// Images found ?\n\t\tif (!(CurrentImages.length > 0)){\n\t\t\tHelper.ReportingError(null, \"No pictures found in folder\", \"Filesystem\", \"updatePictureList\",\"\", false);\n\t\t\treturn { success: false, picturecount: 0 };\n\t\t}else{\n\t\t\tHelper.ReportingInfo(\"Info\", \"Filesystem\", `${CurrentImages.length} pictures found in folder ${Helper.Adapter.config.fs_path}`, {JSON: JSON.stringify(CurrentImages.slice(0, 99))} );\n\t\t\tHelper.ReportingInfo(\"Debug\", \"Filesystem\", `Pictures: ${JSON.stringify(CurrentImages.slice(0, 99))}`)\n\t\t\treturn { success: true, picturecount: CurrentImages.length };\n\t\t}\n\t}catch(err) {\n\t\tHelper.ReportingError(err as Error, \"Unknown Error\", \"Filesystem\", \"updatePictureList\");\n\t\treturn { success: false, picturecount: 0 };\n\t}\n}\n\nasync function getAllFiles(Helper: GlobalHelper, dirPath: string, _arrayOfFiles: string[] = []): Promise<string[]> {\n\t_arrayOfFiles = _arrayOfFiles || [];\n\ttry{\n\t\tconst files = await fs.readdirSync(dirPath);\n\t\tfiles.forEach(async function(file) {\n\t\t\ttry{\n\t\t\t\tif (fs.statSync(dirPath + \"/\" + file).isDirectory()) {\n\t\t\t\t\t_arrayOfFiles = await getAllFiles(Helper, dirPath + \"/\" + file, _arrayOfFiles);\n\t\t\t\t} else {\n\t\t\t\t\t_arrayOfFiles.push(path.join(dirPath, \"/\", file));\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tHelper.ReportingError(err as Error, `Error scanning files: ${err} `, \"Filesystem\", \"getAllFiles\", \"\", false);\n\t\t\t}\n\t\t})\n\t} catch (err){\n\t\tHelper.ReportingError(err as Error, `Error scanning files: ${err} `, \"Filesystem\", \"getAllFiles\", \"\", false);\n\t}\n\treturn _arrayOfFiles;\n}"],
  "mappings": "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",
  "names": []
}
